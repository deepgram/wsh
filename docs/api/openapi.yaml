openapi: "3.1.0"
info:
  title: wsh API
  version: "0.1.0"
  description: >
    wsh exposes terminal I/O via HTTP and WebSocket. This spec covers every
    endpoint, request/response schema, authentication, and error format.
  license:
    name: MIT

servers:
  - url: http://localhost:8080
    description: Default local development server

security:
  - bearerAuth: []
  - queryAuth: []

tags:
  - name: health
    description: Health check (no auth required)
  - name: terminal
    description: Terminal state queries
  - name: input
    description: Input injection and capture
  - name: websocket
    description: Real-time WebSocket streams
  - name: overlay
    description: Overlay management
  - name: panel
    description: Panel management (agent-owned screen regions)
  - name: session
    description: Session management (server mode)
  - name: server
    description: Server lifecycle management
  - name: meta
    description: Documentation and spec endpoints

paths:
  # Note: All per-session endpoints (input, screen, scrollback, ws/raw,
  # ws/json, overlay, panel, quiesce, input/mode, input/capture,
  # input/release) are available under /sessions/{name}/ prefix.
  # For example: /sessions/dev/input, /sessions/dev/screen, etc.

  /health:
    get:
      operationId: getHealth
      summary: Health check
      tags: [health]
      security: []
      responses:
        "200":
          description: Server is healthy.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"

  /input:
    post:
      operationId: postInput
      summary: Inject input bytes into the terminal PTY
      tags: [input]
      description: >
        Sends raw bytes to the terminal. The request body is forwarded
        verbatim to the PTY -- no JSON wrapping.
      requestBody:
        required: true
        content:
          application/octet-stream:
            schema:
              type: string
              format: binary
          text/plain:
            schema:
              type: string
      responses:
        "204":
          description: Input accepted and forwarded to PTY.
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          description: Failed to send input to PTY.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /screen:
    get:
      operationId: getScreen
      summary: Get current visible screen state
      tags: [terminal]
      parameters:
        - name: format
          in: query
          required: false
          schema:
            $ref: "#/components/schemas/Format"
      responses:
        "200":
          description: Current screen state.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ScreenResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "503":
          description: Terminal parser unavailable.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /scrollback:
    get:
      operationId: getScrollback
      summary: Get scrollback buffer contents
      tags: [terminal]
      parameters:
        - name: format
          in: query
          required: false
          schema:
            $ref: "#/components/schemas/Format"
        - name: offset
          in: query
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 0
            default: 100
      responses:
        "200":
          description: Scrollback buffer contents.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ScrollbackResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "503":
          description: Terminal parser unavailable.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /ws/raw:
    get:
      operationId: wsRaw
      summary: Raw binary WebSocket
      tags: [websocket]
      description: >
        Bidirectional byte stream mirroring the PTY. Output arrives as binary
        frames. Send binary or text frames to inject input.
      responses:
        "101":
          description: WebSocket upgrade successful.
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /ws/json:
    get:
      operationId: wsJson
      summary: JSON request/response and event WebSocket
      tags: [websocket]
      description: >
        Unified request/response protocol with event subscriptions. After
        upgrade, server sends {"connected": true}. Client can immediately
        send method calls (get_screen, send_input, subscribe, etc.) and
        receive responses. Subscribing to events is optional. See
        websocket.md for the full protocol specification.
      responses:
        "101":
          description: WebSocket upgrade successful.
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /overlay:
    post:
      operationId: createOverlay
      summary: Create an overlay
      tags: [overlay]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateOverlayRequest"
      responses:
        "201":
          description: Overlay created.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CreateOverlayResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
    get:
      operationId: listOverlays
      summary: List all overlays
      tags: [overlay]
      responses:
        "200":
          description: Array of all overlays.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Overlay"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
    delete:
      operationId: clearOverlays
      summary: Clear all overlays
      tags: [overlay]
      responses:
        "204":
          description: All overlays removed.
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /overlay/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
        description: Overlay ID
    get:
      operationId: getOverlay
      summary: Get a single overlay
      tags: [overlay]
      responses:
        "200":
          description: The overlay.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Overlay"
        "404":
          description: Overlay not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
    put:
      operationId: updateOverlay
      summary: Replace overlay spans
      tags: [overlay]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateOverlayRequest"
      responses:
        "204":
          description: Overlay updated.
        "404":
          description: Overlay not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
    patch:
      operationId: patchOverlay
      summary: Patch overlay position, dimensions, or background
      tags: [overlay]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PatchOverlayRequest"
      responses:
        "204":
          description: Overlay patched.
        "404":
          description: Overlay not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
    delete:
      operationId: deleteOverlay
      summary: Delete an overlay
      tags: [overlay]
      responses:
        "204":
          description: Overlay deleted.
        "404":
          description: Overlay not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /overlay/{id}/spans:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
        description: Overlay ID
    post:
      operationId: updateOverlaySpans
      summary: Partial span update by ID
      tags: [overlay]
      description: >
        Updates only spans whose id matches a span in the request.
        Non-matching spans are left unchanged.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateSpansRequest"
      responses:
        "204":
          description: Spans updated.
        "404":
          description: Overlay not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /overlay/{id}/write:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
        description: Overlay ID
    post:
      operationId: overlayRegionWrite
      summary: Region write (cell-level drawing)
      tags: [overlay]
      description: >
        Writes styled text at specific (row, col) positions within the
        overlay's bounding rectangle.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RegionWriteRequest"
      responses:
        "204":
          description: Region writes applied.
        "404":
          description: Overlay not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /panel:
    post:
      operationId: createPanel
      summary: Create a panel
      tags: [panel]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreatePanelRequest"
      responses:
        "201":
          description: Panel created.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CreatePanelResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
    get:
      operationId: listPanels
      summary: List all panels
      tags: [panel]
      responses:
        "200":
          description: Array of all panels sorted by position then z-order descending.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Panel"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
    delete:
      operationId: clearPanels
      summary: Clear all panels
      tags: [panel]
      responses:
        "204":
          description: All panels removed.
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /panel/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
        description: Panel ID
    get:
      operationId: getPanel
      summary: Get a single panel
      tags: [panel]
      responses:
        "200":
          description: The panel.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Panel"
        "404":
          description: Panel not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
    put:
      operationId: updatePanel
      summary: Replace a panel
      tags: [panel]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdatePanelRequest"
      responses:
        "204":
          description: Panel replaced.
        "404":
          description: Panel not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
    patch:
      operationId: patchPanel
      summary: Partially update a panel
      tags: [panel]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PatchPanelRequest"
      responses:
        "204":
          description: Panel patched.
        "404":
          description: Panel not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
    delete:
      operationId: deletePanel
      summary: Delete a panel
      tags: [panel]
      responses:
        "204":
          description: Panel deleted.
        "404":
          description: Panel not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /panel/{id}/spans:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
        description: Panel ID
    post:
      operationId: updatePanelSpans
      summary: Partial span update by ID
      tags: [panel]
      description: >
        Updates only spans whose id matches a span in the request.
        Non-matching spans are left unchanged.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateSpansRequest"
      responses:
        "204":
          description: Spans updated.
        "404":
          description: Panel not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /panel/{id}/write:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
        description: Panel ID
    post:
      operationId: panelRegionWrite
      summary: Region write (cell-level drawing)
      tags: [panel]
      description: >
        Writes styled text at specific (row, col) positions within the panel.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RegionWriteRequest"
      responses:
        "204":
          description: Region writes applied.
        "404":
          description: Panel not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /quiesce:
    get:
      operationId: getQuiesceAny
      summary: Wait for quiescence on any session
      tags: [session]
      description: >
        Server-level long-poll that races quiescence detection across all
        sessions. Returns the first session to become quiescent, along with
        its screen state and the session name. When last_session and
        last_generation are provided, the named session waits for new activity
        before checking quiescence (preventing busy-loop storms for that
        session), while all other sessions are checked immediately.
        Returns 404 if no sessions exist.
      parameters:
        - name: timeout_ms
          in: query
          required: true
          schema:
            type: integer
            minimum: 1
          description: Quiescence threshold in milliseconds (per session)
        - name: format
          in: query
          required: false
          schema:
            $ref: "#/components/schemas/Format"
        - name: max_wait_ms
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            default: 30000
          description: Overall deadline in milliseconds
        - name: last_generation
          in: query
          required: false
          schema:
            type: integer
            minimum: 0
          description: >
            Generation from a previous quiescence response. Used together
            with last_session. If the named session's current generation
            matches, it waits for new activity before checking quiescence.
        - name: last_session
          in: query
          required: false
          schema:
            type: string
          description: >
            Session name from a previous quiescence response. Used together
            with last_generation to prevent busy-loop storms on a specific
            session while still racing all other sessions.
        - name: fresh
          in: query
          required: false
          schema:
            type: boolean
            default: false
          description: >
            When true, always observe at least timeout_ms of real silence
            before responding, even if a session is already idle. Trades
            latency for API simplicity (no generation tracking required).
      responses:
        "200":
          description: A session is quiescent. Returns session name and screen state.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/QuiesceAnyResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          description: No sessions exist.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "408":
          description: Deadline exceeded without quiescence on any session.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /input/mode:
    get:
      operationId: getInputMode
      summary: Get current input mode
      tags: [input]
      responses:
        "200":
          description: Current input mode.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InputModeResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /input/capture:
    post:
      operationId: postInputCapture
      summary: Switch to capture mode
      tags: [input]
      description: >
        In capture mode, keyboard input is broadcast to API subscribers
        but not forwarded to the PTY. Idempotent for the same owner.
        Returns 409 if another owner holds the capture.
      parameters:
        - name: owner
          in: query
          required: false
          description: >
            Owner identifier for this capture. If omitted, a random UUID is
            assigned. Only the owner can release the capture.
          schema:
            type: string
      responses:
        "204":
          description: Mode switched to capture.
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "409":
          description: Input already captured by another owner.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /input/release:
    post:
      operationId: postInputRelease
      summary: Switch to passthrough mode
      tags: [input]
      description: >
        In passthrough mode, keyboard input goes to both API subscribers
        and the PTY. Also clears input focus. Only the current capture
        owner can release. Returns 409 if caller is not the owner.
      parameters:
        - name: owner
          in: query
          required: false
          description: >
            Must match the owner that captured input. If omitted, a random
            UUID is used (which will likely not match).
          schema:
            type: string
      responses:
        "204":
          description: Mode switched to passthrough.
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "409":
          description: Caller is not the capture owner.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /input/focus:
    get:
      operationId: getInputFocus
      summary: Get current input focus
      tags: [input]
      responses:
        "200":
          description: Current focus state.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/FocusResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
    post:
      operationId: postInputFocus
      summary: Set input focus to a focusable element
      tags: [input]
      description: >
        Sets input focus to the specified overlay or panel. The element
        must exist and have focusable: true.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/FocusRequest"
      responses:
        "204":
          description: Focus set.
        "400":
          description: Element not found or not focusable.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /input/unfocus:
    post:
      operationId: postInputUnfocus
      summary: Clear input focus
      tags: [input]
      responses:
        "204":
          description: Focus cleared.
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /screen_mode:
    get:
      operationId: getScreenMode
      summary: Get current screen mode
      tags: [terminal]
      responses:
        "200":
          description: Current screen mode.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ScreenModeResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /screen_mode/enter_alt:
    post:
      operationId: enterAltScreen
      summary: Enter alternate screen mode
      tags: [terminal]
      description: >
        Switches the session to alternate screen mode. New overlays and panels
        are tagged with screen_mode alt. Returns 409 if already in alt mode.
      responses:
        "204":
          description: Entered alt screen mode.
        "409":
          description: Already in alt screen mode.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /screen_mode/exit_alt:
    post:
      operationId: exitAltScreen
      summary: Exit alternate screen mode
      tags: [terminal]
      description: >
        Switches back to normal screen mode. All alt-mode overlays and panels
        are deleted. Returns 409 if already in normal mode.
      responses:
        "204":
          description: Exited alt screen mode.
        "409":
          description: Not in alt screen mode.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /openapi.yaml:
    get:
      operationId: getOpenApiSpec
      summary: OpenAPI specification
      tags: [meta]
      security: []
      responses:
        "200":
          description: This OpenAPI spec.
          content:
            text/yaml:
              schema:
                type: string

  /docs:
    get:
      operationId: getDocs
      summary: API documentation
      tags: [meta]
      security: []
      responses:
        "200":
          description: API documentation in Markdown.
          content:
            text/markdown:
              schema:
                type: string

  # --- Session Management (server mode) ---

  /sessions:
    get:
      operationId: listSessions
      summary: List all active sessions
      tags: [session]
      responses:
        "200":
          description: Array of all sessions.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/SessionInfo"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
    post:
      operationId: createSession
      summary: Create a new session
      tags: [session]
      description: >
        Spawns a new PTY session with the specified command (or the user's
        default shell). Returns the assigned session name.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateSessionRequest"
      responses:
        "201":
          description: Session created.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SessionInfo"
        "409":
          description: Session name already exists.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Failed to create session.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "503":
          description: Maximum number of sessions reached.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /sessions/{name}:
    parameters:
      - name: name
        in: path
        required: true
        schema:
          type: string
        description: Session name
    get:
      operationId: getSession
      summary: Get session info
      tags: [session]
      responses:
        "200":
          description: Session info.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SessionInfo"
        "404":
          description: Session not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
    patch:
      operationId: renameSession
      summary: Rename a session
      tags: [session]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RenameSessionRequest"
      responses:
        "200":
          description: Session renamed.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SessionInfo"
        "404":
          description: Session not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "409":
          description: New name already exists.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
    delete:
      operationId: killSession
      summary: Kill (destroy) a session
      tags: [session]
      description: >
        Destroys the session and its PTY process.
      responses:
        "204":
          description: Session destroyed.
        "404":
          description: Session not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  # --- Session-Scoped Endpoints ---
  # These are identical to the top-level endpoints but scoped to a named session.

  /sessions/{name}/input:
    post:
      operationId: postSessionInput
      summary: Inject input into a named session's PTY
      tags: [session, input]
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/octet-stream:
            schema:
              type: string
              format: binary
      responses:
        "200":
          description: Input accepted.
        "404":
          description: Session not found.

  /sessions/{name}/screen:
    get:
      operationId: getSessionScreen
      summary: Get the current screen of a named session
      tags: [session, terminal]
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
        - name: format
          in: query
          schema:
            $ref: "#/components/schemas/Format"
      responses:
        "200":
          description: Current screen state.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ScreenResponse"
        "404":
          description: Session not found.

  /sessions/{name}/scrollback:
    get:
      operationId: getSessionScrollback
      summary: Get scrollback buffer of a named session
      tags: [session, terminal]
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
        - name: format
          in: query
          schema:
            $ref: "#/components/schemas/Format"
        - name: offset
          in: query
          schema:
            type: integer
        - name: limit
          in: query
          schema:
            type: integer
      responses:
        "200":
          description: Scrollback lines.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ScrollbackResponse"
        "404":
          description: Session not found.

  /sessions/{name}/ws/json:
    get:
      operationId: sessionWsJson
      summary: Per-session JSON WebSocket
      tags: [session, websocket]
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
      description: >
        WebSocket upgrade for per-session real-time events and method calls.
        Same protocol as /ws/json but scoped to a single session.
      responses:
        "101":
          description: WebSocket upgrade.
        "404":
          description: Session not found.

  /sessions/{name}/ws/raw:
    get:
      operationId: sessionWsRaw
      summary: Per-session raw binary WebSocket
      tags: [session, websocket]
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
      description: >
        WebSocket upgrade for raw PTY I/O on a specific session.
      responses:
        "101":
          description: WebSocket upgrade.
        "404":
          description: Session not found.

  /sessions/{name}/detach:
    post:
      operationId: detachSession
      summary: Detach all clients from a session
      tags: [session]
      description: >
        Detaches all connected clients (Unix socket wsh attach sessions) from
        the named session. The session itself remains alive.
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
          description: Session name
      responses:
        "204":
          description: All clients detached.
        "404":
          description: Session not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  # --- Server Management ---

  /server/persist:
    post:
      operationId: serverPersist
      summary: Switch server to persistent mode
      tags: [server]
      description: >
        Switches the server from ephemeral mode (shuts down when last session
        exits) to persistent mode (stays alive indefinitely). This is a one-way
        operation.
      responses:
        "200":
          description: Server switched to persistent mode.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ServerPersistResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      description: "Authorization: Bearer <token>"
    queryAuth:
      type: apiKey
      in: query
      name: token
      description: "?token=<token> query parameter"

  responses:
    Unauthorized:
      description: No credentials provided.
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    Forbidden:
      description: Invalid credentials.
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"

  schemas:
    # --- Enumerations ---

    Format:
      type: string
      enum: [plain, styled]
      default: styled

    InputMode:
      type: string
      enum: [passthrough, capture]

    # --- Terminal Colors ---

    Color:
      description: Terminal color (256-color palette or true color).
      oneOf:
        - type: object
          required: [indexed]
          properties:
            indexed:
              type: integer
              minimum: 0
              maximum: 255
          additionalProperties: false
        - type: object
          required: [rgb]
          properties:
            rgb:
              type: object
              required: [r, g, b]
              properties:
                r: { type: integer, minimum: 0, maximum: 255 }
                g: { type: integer, minimum: 0, maximum: 255 }
                b: { type: integer, minimum: 0, maximum: 255 }
              additionalProperties: false
          additionalProperties: false

    NamedColor:
      type: string
      enum: [black, red, green, yellow, blue, magenta, cyan, white]

    OverlayColor:
      description: Overlay color (named string or RGB object).
      oneOf:
        - $ref: "#/components/schemas/NamedColor"
        - type: object
          required: [r, g, b]
          properties:
            r: { type: integer, minimum: 0, maximum: 255 }
            g: { type: integer, minimum: 0, maximum: 255 }
            b: { type: integer, minimum: 0, maximum: 255 }
          additionalProperties: false

    # --- Terminal State ---

    Span:
      type: object
      required: [text]
      properties:
        text: { type: string }
        fg: { $ref: "#/components/schemas/Color" }
        bg: { $ref: "#/components/schemas/Color" }
        bold: { type: boolean }
        faint: { type: boolean }
        italic: { type: boolean }
        underline: { type: boolean }
        strikethrough: { type: boolean }
        blink: { type: boolean }
        inverse: { type: boolean }
      description: >
        Style fields are omitted when false/unset (skip_serializing_if).

    FormattedLine:
      description: >
        Either a plain string (no styling) or an array of styled Spans.
        Uses untagged serialization.
      oneOf:
        - type: string
        - type: array
          items: { $ref: "#/components/schemas/Span" }

    Cursor:
      type: object
      required: [row, col, visible]
      properties:
        row: { type: integer, minimum: 0 }
        col: { type: integer, minimum: 0 }
        visible: { type: boolean }

    ScreenResponse:
      type: object
      required: [epoch, first_line_index, total_lines, lines, cursor, cols, rows, alternate_active]
      properties:
        epoch: { type: integer, minimum: 0 }
        first_line_index: { type: integer, minimum: 0 }
        total_lines: { type: integer, minimum: 0 }
        lines: { type: array, items: { $ref: "#/components/schemas/FormattedLine" } }
        cursor: { $ref: "#/components/schemas/Cursor" }
        cols: { type: integer, minimum: 1 }
        rows: { type: integer, minimum: 1 }
        alternate_active: { type: boolean }

    ScrollbackResponse:
      type: object
      required: [epoch, lines, total_lines, offset]
      properties:
        epoch: { type: integer, minimum: 0 }
        lines: { type: array, items: { $ref: "#/components/schemas/FormattedLine" } }
        total_lines: { type: integer, minimum: 0 }
        offset: { type: integer, minimum: 0 }

    CursorResponse:
      type: object
      required: [epoch, cursor]
      properties:
        epoch: { type: integer, minimum: 0 }
        cursor: { $ref: "#/components/schemas/Cursor" }

    # --- Overlays ---

    OverlaySpan:
      type: object
      required: [text]
      properties:
        id:
          type: string
          description: Named identifier for partial span updates.
        text: { type: string }
        fg: { $ref: "#/components/schemas/OverlayColor" }
        bg: { $ref: "#/components/schemas/OverlayColor" }
        bold: { type: boolean, default: false }
        italic: { type: boolean, default: false }
        underline: { type: boolean, default: false }

    BackgroundStyle:
      type: object
      required: [bg]
      properties:
        bg: { $ref: "#/components/schemas/OverlayColor" }
      description: Background fill color for an overlay or panel.

    RegionWrite:
      type: object
      required: [row, col, text]
      properties:
        row: { type: integer, minimum: 0 }
        col: { type: integer, minimum: 0 }
        text: { type: string }
        fg: { $ref: "#/components/schemas/OverlayColor" }
        bg: { $ref: "#/components/schemas/OverlayColor" }
        bold: { type: boolean, default: false }
        italic: { type: boolean, default: false }
        underline: { type: boolean, default: false }
      description: Styled text write at a specific (row, col) offset.

    ScreenMode:
      type: string
      enum: [normal, alt]
      description: Which screen mode an element belongs to.

    Overlay:
      type: object
      required: [id, x, y, z, width, height, spans]
      properties:
        id: { type: string }
        x: { type: integer, minimum: 0 }
        y: { type: integer, minimum: 0 }
        z: { type: integer }
        width: { type: integer, minimum: 0 }
        height: { type: integer, minimum: 0 }
        background: { $ref: "#/components/schemas/BackgroundStyle" }
        spans: { type: array, items: { $ref: "#/components/schemas/OverlaySpan" } }
        region_writes:
          type: array
          items: { $ref: "#/components/schemas/RegionWrite" }
          description: Omitted when empty.
        focusable:
          type: boolean
          default: false
          description: Omitted when false.
        screen_mode:
          $ref: "#/components/schemas/ScreenMode"
          description: Omitted when normal.

    CreateOverlayRequest:
      type: object
      required: [x, y, width, height, spans]
      properties:
        x: { type: integer, minimum: 0 }
        y: { type: integer, minimum: 0 }
        z: { type: integer }
        width: { type: integer, minimum: 0 }
        height: { type: integer, minimum: 0 }
        background: { $ref: "#/components/schemas/BackgroundStyle" }
        spans: { type: array, items: { $ref: "#/components/schemas/OverlaySpan" } }
        focusable: { type: boolean, default: false }

    CreateOverlayResponse:
      type: object
      required: [id]
      properties:
        id: { type: string }

    UpdateOverlayRequest:
      type: object
      required: [spans]
      properties:
        spans: { type: array, items: { $ref: "#/components/schemas/OverlaySpan" } }

    PatchOverlayRequest:
      type: object
      properties:
        x: { type: integer, minimum: 0 }
        y: { type: integer, minimum: 0 }
        z: { type: integer }
        width: { type: integer, minimum: 0 }
        height: { type: integer, minimum: 0 }
        background: { $ref: "#/components/schemas/BackgroundStyle" }

    UpdateSpansRequest:
      type: object
      required: [spans]
      properties:
        spans:
          type: array
          items: { $ref: "#/components/schemas/OverlaySpan" }
          description: Spans with id fields to match against existing spans.

    RegionWriteRequest:
      type: object
      required: [writes]
      properties:
        writes:
          type: array
          items: { $ref: "#/components/schemas/RegionWrite" }

    # --- Panels ---

    PanelPosition:
      type: string
      enum: [top, bottom]

    Panel:
      type: object
      required: [id, position, height, z, spans, visible]
      properties:
        id: { type: string }
        position: { $ref: "#/components/schemas/PanelPosition" }
        height: { type: integer, minimum: 1 }
        z: { type: integer }
        background: { $ref: "#/components/schemas/BackgroundStyle" }
        spans: { type: array, items: { $ref: "#/components/schemas/OverlaySpan" } }
        region_writes:
          type: array
          items: { $ref: "#/components/schemas/RegionWrite" }
          description: Omitted when empty.
        visible: { type: boolean }
        focusable:
          type: boolean
          default: false
          description: Omitted when false.
        screen_mode:
          $ref: "#/components/schemas/ScreenMode"
          description: Omitted when normal.

    CreatePanelRequest:
      type: object
      required: [position, height]
      properties:
        position: { $ref: "#/components/schemas/PanelPosition" }
        height: { type: integer, minimum: 1 }
        z: { type: integer }
        background: { $ref: "#/components/schemas/BackgroundStyle" }
        spans: { type: array, items: { $ref: "#/components/schemas/OverlaySpan" } }
        focusable: { type: boolean, default: false }

    CreatePanelResponse:
      type: object
      required: [id]
      properties:
        id: { type: string }

    UpdatePanelRequest:
      type: object
      required: [position, height, z, spans]
      properties:
        position: { $ref: "#/components/schemas/PanelPosition" }
        height: { type: integer, minimum: 1 }
        z: { type: integer }
        spans: { type: array, items: { $ref: "#/components/schemas/OverlaySpan" } }

    PatchPanelRequest:
      type: object
      properties:
        position: { $ref: "#/components/schemas/PanelPosition" }
        height: { type: integer, minimum: 1 }
        z: { type: integer }
        background: { $ref: "#/components/schemas/BackgroundStyle" }
        spans: { type: array, items: { $ref: "#/components/schemas/OverlaySpan" } }

    # --- Input ---

    InputModeResponse:
      type: object
      required: [mode]
      properties:
        mode: { $ref: "#/components/schemas/InputMode" }

    FocusRequest:
      type: object
      required: [id]
      properties:
        id:
          type: string
          description: ID of the overlay or panel to focus.

    FocusResponse:
      type: object
      required: [focused]
      properties:
        focused:
          oneOf:
            - type: string
            - type: "null"
          description: ID of the focused element, or null.

    ScreenModeResponse:
      type: object
      required: [mode]
      properties:
        mode: { $ref: "#/components/schemas/ScreenMode" }

    # --- Sessions ---

    SessionInfo:
      type: object
      required: [name]
      properties:
        name: { type: string }

    CreateSessionRequest:
      type: object
      properties:
        name:
          type: string
          description: Session name (auto-generated if omitted).
        command:
          type: string
          description: Command to run (defaults to user's shell).
        rows:
          type: integer
          minimum: 1
          default: 24
          description: Terminal rows.
        cols:
          type: integer
          minimum: 1
          default: 80
          description: Terminal columns.
        cwd:
          type: string
          description: Working directory for the session.
        env:
          type: object
          additionalProperties: { type: string }
          description: Additional environment variables.

    RenameSessionRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string
          description: New session name.

    # --- Server Management ---

    ServerPersistResponse:
      type: object
      required: [persistent]
      properties:
        persistent: { type: boolean }

    SetServerModeParams:
      type: object
      required: [persistent]
      properties:
        persistent:
          type: boolean
          description: >
            true for persistent mode (server stays alive when all sessions
            exit), false for ephemeral mode (server shuts down when last
            session exits).

    SetServerModeResult:
      type: object
      required: [persistent]
      properties:
        persistent: { type: boolean }

    # --- WebSocket Messages ---

    WsRequest:
      description: >
        Client-to-server request over /ws/json. All messages use this envelope.
        On the server-level WebSocket, per-session methods require a "session"
        field to identify the target session. Server-level methods
        (list_sessions, create_session, kill_session, detach_session,
        rename_session, set_server_mode) do not require it.
      type: object
      required: [method]
      properties:
        id:
          description: Optional client-chosen ID, echoed in response.
          oneOf:
            - type: integer
            - type: string
        method:
          type: string
          description: Method name to invoke.
        params:
          type: object
          description: Method-specific parameters.
        session:
          type: string
          description: >
            Target session name. Required for per-session methods on the
            server-level WebSocket. Ignored on per-session WebSocket endpoints.

    WsResponse:
      description: >
        Server-to-client response over /ws/json. Contains either result or
        error, never both. For protocol-level errors (malformed request),
        method and id may be absent.
      type: object
      properties:
        id:
          description: Echoed from request, absent if not provided.
          oneOf:
            - type: integer
            - type: string
        method:
          type: string
          description: Echoed method name. Absent for protocol-level errors.
        result:
          description: Successful result (mutually exclusive with error).
        error:
          $ref: "#/components/schemas/WsError"

    WsError:
      type: object
      required: [code, message]
      properties:
        code: { type: string }
        message: { type: string }

    SubscribeParams:
      type: object
      required: [events]
      properties:
        events: { type: array, items: { $ref: "#/components/schemas/EventType" } }
        interval_ms: { type: integer, minimum: 0, default: 100 }
        format: { $ref: "#/components/schemas/Format" }
        quiesce_ms:
          type: integer
          minimum: 0
          default: 0
          description: >
            When > 0, emit a sync event after this many ms of terminal
            inactivity following any activity. 0 = disabled.

    SendInputParams:
      type: object
      required: [data]
      properties:
        data:
          type: string
          description: Input data (plain string or base64-encoded).
        encoding:
          type: string
          enum: [utf8, base64]
          default: utf8
          description: >
            Encoding of the data field. With utf8 (default), JSON unicode
            escapes handle control characters. With base64, data is decoded
            before sending to the PTY.

    AwaitQuiesceParams:
      type: object
      required: [timeout_ms]
      properties:
        timeout_ms:
          type: integer
          minimum: 1
          description: Quiescence threshold in milliseconds
        format: { $ref: "#/components/schemas/Format" }
        max_wait_ms:
          type: integer
          minimum: 1
          description: Overall deadline in milliseconds (omit for no deadline)
        last_generation:
          type: integer
          minimum: 0
          description: >
            Generation from a previous quiescence response. If provided and
            matches the current generation, the server waits for new activity
            before checking quiescence.
        fresh:
          type: boolean
          default: false
          description: >
            When true, always observe real silence for timeout_ms before
            responding, even if the terminal is already idle.

    QuiesceResponse:
      type: object
      required: [screen, scrollback_lines, generation]
      properties:
        screen: { $ref: "#/components/schemas/ScreenResponse" }
        scrollback_lines: { type: integer, minimum: 0 }
        generation:
          type: integer
          minimum: 0
          description: >
            Monotonic activity generation counter. Pass back as
            last_generation on subsequent requests to avoid busy-loop
            storms when the terminal is idle.

    QuiesceAnyResponse:
      type: object
      required: [session, screen, scrollback_lines, generation]
      properties:
        session:
          type: string
          description: Name of the session that became quiescent.
        screen: { $ref: "#/components/schemas/ScreenResponse" }
        scrollback_lines: { type: integer, minimum: 0 }
        generation:
          type: integer
          minimum: 0
          description: >
            Monotonic activity generation counter for the quiescent session.
            Pass back as last_generation (with last_session) on subsequent
            requests to avoid busy-loop storms.

    EventType:
      type: string
      enum: [lines, chars, cursor, mode, diffs, input, overlay]

    Event:
      description: Discriminated union of all event types, tagged by "event" field.
      oneOf:
        - $ref: "#/components/schemas/LineEvent"
        - $ref: "#/components/schemas/CursorEvent"
        - $ref: "#/components/schemas/ModeEvent"
        - $ref: "#/components/schemas/ResetEvent"
        - $ref: "#/components/schemas/SyncEvent"
        - $ref: "#/components/schemas/DiffEvent"
      discriminator:
        propertyName: event
        mapping:
          line: "#/components/schemas/LineEvent"
          cursor: "#/components/schemas/CursorEvent"
          mode: "#/components/schemas/ModeEvent"
          reset: "#/components/schemas/ResetEvent"
          sync: "#/components/schemas/SyncEvent"
          diff: "#/components/schemas/DiffEvent"

    LineEvent:
      type: object
      required: [event, seq, index, total_lines, line]
      properties:
        event: { type: string, const: line }
        seq: { type: integer, minimum: 0 }
        index: { type: integer, minimum: 0 }
        total_lines: { type: integer, minimum: 0 }
        line: { $ref: "#/components/schemas/FormattedLine" }

    CursorEvent:
      type: object
      required: [event, seq, row, col, visible]
      properties:
        event: { type: string, const: cursor }
        seq: { type: integer, minimum: 0 }
        row: { type: integer, minimum: 0 }
        col: { type: integer, minimum: 0 }
        visible: { type: boolean }

    ModeEvent:
      type: object
      required: [event, seq, alternate_active]
      properties:
        event: { type: string, const: mode }
        seq: { type: integer, minimum: 0 }
        alternate_active: { type: boolean }

    ResetEvent:
      type: object
      required: [event, seq, reason]
      properties:
        event: { type: string, const: reset }
        seq: { type: integer, minimum: 0 }
        reason: { $ref: "#/components/schemas/ResetReason" }

    ResetReason:
      type: string
      enum: [clear_screen, clear_scrollback, hard_reset, alternate_screen_enter, alternate_screen_exit, resize]

    SyncEvent:
      type: object
      required: [event, seq, screen, scrollback_lines]
      properties:
        event: { type: string, const: sync }
        seq: { type: integer, minimum: 0 }
        screen: { $ref: "#/components/schemas/ScreenResponse" }
        scrollback_lines: { type: integer, minimum: 0 }

    DiffEvent:
      type: object
      required: [event, seq, changed_lines, screen]
      properties:
        event: { type: string, const: diff }
        seq: { type: integer, minimum: 0 }
        changed_lines: { type: array, items: { type: integer, minimum: 0 } }
        screen: { $ref: "#/components/schemas/ScreenResponse" }

    # --- Input Events (WebSocket) ---

    InputEvent:
      description: Input events broadcast via WebSocket.
      oneOf:
        - $ref: "#/components/schemas/InputInputEvent"
        - $ref: "#/components/schemas/InputModeChangeEvent"
      discriminator:
        propertyName: event
        mapping:
          input: "#/components/schemas/InputInputEvent"
          mode: "#/components/schemas/InputModeChangeEvent"

    InputInputEvent:
      type: object
      required: [event, mode, raw]
      properties:
        event: { type: string, const: input }
        mode: { $ref: "#/components/schemas/InputMode" }
        raw: { type: array, items: { type: integer, minimum: 0, maximum: 255 } }
        parsed:
          oneOf:
            - $ref: "#/components/schemas/ParsedKey"
            - type: "null"

    InputModeChangeEvent:
      type: object
      required: [event, mode]
      properties:
        event: { type: string, const: mode }
        mode: { $ref: "#/components/schemas/InputMode" }

    ParsedKey:
      type: object
      required: [key, modifiers]
      properties:
        key:
          oneOf:
            - type: string
            - type: "null"
        modifiers: { type: array, items: { type: string } }

    # --- Common ---

    HealthResponse:
      type: object
      required: [status]
      properties:
        status: { type: string }

    ErrorResponse:
      type: object
      required: [error]
      properties:
        error:
          type: object
          required: [code, message]
          properties:
            code:
              type: string
              enum:
                - auth_required
                - auth_invalid
                - not_found
                - overlay_not_found
                - panel_not_found
                - session_not_found
                - invalid_request
                - invalid_overlay
                - invalid_input_mode
                - invalid_format
                - unknown_method
                - channel_full
                - parser_unavailable
                - input_send_failed
                - input_capture_failed
                - quiesce_timeout
                - parser_timeout
                - no_sessions
                - max_sessions_reached
                - session_create_failed
                - session_name_conflict
                - not_focusable
                - already_in_alt_screen
                - not_in_alt_screen
                - internal_error
            message: { type: string }
